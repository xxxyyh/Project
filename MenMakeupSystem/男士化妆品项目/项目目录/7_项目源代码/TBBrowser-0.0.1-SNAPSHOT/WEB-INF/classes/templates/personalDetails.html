<!DOCTYPE html>
<html xmlns:th="http:www.thymeleaf.org">

	<head>
		<meta charset="UTF-8">
		<title>个人信息</title>
		<link rel="stylesheet" type="text/css" th:href="@{/css/bootstrap.css}"/>
		<link rel="stylesheet" th:href="@{/css/base.css}">
		<link rel="stylesheet" th:href="@{/css/resiter.css}">
		<link rel="stylesheet" th:href="@{/css/personalDetails.css}">
	</head>

	<body>
		<!--头部开始-->
		<div class="header ">
			<div class="inner">
				<div class="left clearfix">
					<a th:href="@{/index.html}">
						<img th:src="@{/images/logo.png}" alt="">
					</a>
				</div>
				<div class="right">
					<ul class="clearfix">
						<li>
							<a th:href="@{/index.html}">首页</a>
						</li>
						<li>
							<a href="#">全部产品</a>
						</li>
						<li>
							<a href="#">专柜地址</a>
						</li>
						<li>
							<a href="#" style="margin-right: 50px">客服中心</a>
						</li>
						<li>
							<a href="#">订阅电子杂志</a>
						</li>
						<li>
							<a th:href="@{aboutUs.html}">我的购物车<span></span></a>
						</li>
						<li id="li-login">
							<a th:href="@{/login.html}">登录</a>
							<a th:href="@{/resiter.html}">注册</a>
							<!--<span th:text="${session.currentUser.useraccount}"></span>-->
						</li>
						<li class="dropdown">
							<a id="li-useraccount" class="dropdown-toggle" data-toggle="dropdown" >
								账号:<span id="useraccount"></span>
							</a>
							<img  id="li-usericon" class="dropdown-toggle" data-toggle="dropdown" style="width:45px;height:45px; border-radius: 100%;">
							<ul class="dropdown-menu" aria-labelledby="dropdownScale">
								<li class="scale-item" ><a th:href="@{/personalDetails.html}"><span class="fa fa-edit"></span>个人信息</a></li>
								<li class="scale-item" ><a th:href="@{/myOrder.html}"><span class="fa fa-edit" ></span>我的订单</a></li>
								<li class="scale-item" ><a id="logout">退出系统</a></li>
							</ul>
						</li>
						<!--<li id="li-usericon">
							<img id="icon" style="width: 50px;height: 50px;"></img>
						</li>-->
					</ul>
				</div>
			</div>
		</div>
		<!--头部结束-->
		<div class="clear"></div>
		<!--导航栏开始-->
		<div class="nav">
			<div class="inner">
				<ul class="clearfix">
					<li>
						<a href="#">脸部护理</a>
					</li>
					<li>
						<a href="#">身体护理</a>
					</li>
					<li>
						<a href="#">防晒隔离</a>
					</li>
					<li>
						<a href="#">明星产品</a>
					</li>
					<li>
						<a href="#">会员中心</a>
					</li>
					<li>
						<a href="#">特惠礼盒</a>
					</li>
					<li>
						<a href="#">品牌资讯</a>
					</li>
					<li>
						<a href="#">关于我们</a>
					</li>
				</ul>
				<div class="search">
					<input type="text" placeholder="搜索三体">
					<span></span>
				</div>
			</div>
		</div>
		<!--导航栏结束-->
		<div class="banner">
			<div class="inner">
				<a href="#"><img th:src="@{/images/banner1.jpg}" alt=""></a>
			</div>
		</div>
		<!--登陆模块开始-->
		<div class="resiter">
			<div class="inner clearfix">
				<h1><a th:href="@{/index.html}">ThreeBody男妆官网</a></h1>
				<div class="right clearfix">
					<form id="form-edituser">
						<h2>我的个人信息</h2>
						<span>账&emsp;&emsp;号:</span> <input type="text" id="account" name="useraccount" readonly="readonly">
						<input type="hidden" id="icon" name="usericon">
						<input type="hidden" id="userid" name="userid">
						<br>
						<br>
						<span>昵&emsp;&emsp;称:</span> <input type="text" id="userpetname" name="userpetname" placeholder="请输入您的账号">
						<br>
						<label id="txtUserpetname"></label>
						<br>
						<span>密&emsp;&emsp;码:</span> <input type="password" id="userpassword1" name="userpassword" placeholder="请输入您的密码">
						<br>
						<label id="txtUserpassword1"></label>
						<br>
						<span>确认密码:</span> <input type="password" id="userpassword2" placeholder="确认您的密码">
						<br>
						<label id="txtUserpassword2"></label>
						<br>
						<span>邮&emsp;&emsp;箱:</span> <input type="text" id="useremail" name="useremail" placeholder="请输入您的邮箱">
						<br>
						<label id="txtUseremail"></label>
						<br>
						<span>手机号码:</span> <input type="text" id="usertel" name="usertel" placeholder="请输入您的手机号码">
						<br>
						<label id="txtUsertel"></label>
						<br>
						<span>真实姓名:</span> <input type="text" id="username" name="username" placeholder="请输入您的真实姓名">
						<br>
						<label id="txtUsername"></label>
						<br>
						<span>身份证号:</span> <input type="text" id="useridcard" name="useridcard" placeholder="请输入您的身份证号">
						<br>
						<label id="txtUseridcard"></label>
						<br>
						<span>年&emsp;&emsp;龄:</span> <input type="number" id="userage" name="userage" min="1" max="150" placeholder="请输入您的年龄">
						<br>
						<label id="txtUserage"></label>
						<br>
						<span style="margin-left: -112px;">性&emsp;&emsp;别：</span> <input type="radio" name="usersex" value="男">男
						<input type="radio" name="usersex" value="女">女
						<br>
						<br>
					</form>
					<form id="from-upload" enctype="multipart/form-data">
						<span>头&emsp;&emsp;像:</span> <input type="file" id="usericon" name="usericon" placeholder="请选择您的头像" style="display: inline;">
					</form>
					<br>
					<br>
					<br>
					<a id="editUserBtn" class="btn btn-info btn-xs" style="width: 160px;height: 40px;font-size: 18px;line-height: 40px;color: white">修改个人信息</a>
				</div>
				<div class="left clearfix">
					<img th:src="@{/images/threebody.png}" alt="">
					<p>欢迎来到ThreeBody男妆官网</p>
				</div>
			</div>
		</div>
		<!--登陆模块结束-->

		<!--页脚开始-->
		<div class="foot">
			<div class="inner">
				<ul>
					<li>
						<h1>脸部护理</h1>
						<div>活泉系列-保湿</div>
						<div>蓝源系列-抗老</div>
						<div>奇迹系列-修护</div>
						<div>滢澈皙白系列-美白</div>
					</li>
					<li>
						<h1>身体护理</h1>
						<div>凝乳丝滑系列-润肤</div>
						<div>光感纤体系列-塑身</div>
						<div>保湿香氛系列-香氛</div>
						<div>阳光欢愉系列-清爽</div>
					</li>
					<li>
						<h1>防晒隔离</h1>
						<div>防晒</div>
						<div>隔离</div>
						<div>气垫</div>
					</li>
					<li>
						<h1>品牌故事</h1>
						<div>ThreeBody故事</div>
						<div>逾60年致力于护肤 </div>
						<div>ThreeBody灵魂成分 </div>
						<div>ThreeBody的承诺 </div>
					</li>
					<li>
						<h1>帮助中心</h1>
						<div>订单查询</div>
						<div>常见问题</div>
						<div>联系我们</div>
						<div>法律信息</div>
						<div>网站地图</div>
					</li>
					<li class="footRight">
						<h1>关注我们</h1>
						<a href="https://weibo.com/u/6434760509"> <span style="color: red"></span></a>
						<span id="wechat" style="color: lawngreen"></span>
						<span id="phone" style="color: deepskyblue"></span>
						<section class="wechat">
							<p>了解详情请关注我们的官方微信号</p>
							<img th:src="@{/images/wechat.jpg}" alt="">
						</section>
						<section class="phone">
							<p>欢迎您致电我们的服务电话!</p>
							<p>&emsp;15363391819</p>
						</section>
					</li>
				</ul>
				<div class="clear"></div>
				<div class="copyright">
					<p> ©ThreeBody男妆版权所有:韩山师范学院计算机与信息工程学院“三体”小组，其中成员有丘彪、徐奕海、杨小辉、廖伟俊、何佳佳、崔灵涛。
					</p>
					<p>
						抄袭必追究法律责任。欢迎探讨学习！
					</p>
				</div>
			</div>
		</div>
		<!--页脚结束-->

		<!--js开始-->
		<script th:src="@{js/jquery.min.js}"></script>
		<script th:src="@{js/restful.js}"></script>
		<script th:src="@{js/bootstrap.min.js}"></script>
		<!--页脚“关注我们”模块特效开始-->
		<script>
			$('#wechat').mouseenter(function() {
				$('.wechat').css({
					display: "block"
				})
			}).mouseleave(function() {
				$('.wechat').css({
					display: "none"
				})
			})
			$('#phone').mouseenter(function() {
				$('.phone').css({
					display: "block"
				})
			}).mouseleave(function() {
				$('.phone').css({
					display: "none"
				})
			})
		</script>
		<!--页脚“关注我们”模块特效结束-->
		
		<!-- 自定义js -->
		<script type="text/javascript" th:inline="javascript">
			var currentUser = JSON.parse(sessionStorage.getItem("currentUser"));
			var upnIsNull = true;//昵称是否为空
			var upsdIsNull = true;//密码是否为空
			var utlIsNull = true;//手机号是否为空
			var uemlIsNull = true;//邮箱是否为空
			var uageIsNull = true;//邮箱是否为空
			
			/*
			 * 登录状态
			 * */
			console.log(currentUser);
			if(currentUser != null){
				var useraccount = currentUser.useraccount;
				var usericon = currentUser.usericon;
				if(usericon != null){
					$("#li-login").css({display: "none"});
					$("#li-useraccount").css({display: "none"});
					$("#li-usericon").css({display: "block"});
					$("#li-usericon").attr("src",usericon);
				}else if(useraccount != null){
					$("#li-login").css({display: "none"});
					$("#li-usericon").css({display: "none"});
					$("#li-useraccount").css({display: "block"});
					$("#useraccount").text(useraccount);
				}
				/*给输入赋值
				 */
				$("#account").val(useraccount);
				if(currentUser.userpetname != null){
					$("#userpetname").val(currentUser.userpetname);
				}
				if(currentUser.userid != null){
					$("#userid").val(currentUser.userid);
				}
				if(currentUser.useremail != null){
					$("#useremail").val(currentUser.useremail);
				}
				if(currentUser.usertel != null){
					$("#usertel").val(currentUser.usertel);
				}
				if(currentUser.username != null){
					$("#username").val(currentUser.username);
				}
				if(currentUser.useridcard != null){
					$("#useridcard").val(currentUser.useridcard);
				}
				if(currentUser.userage != null){
					$("#userage").val(currentUser.userage);
				}
				if(currentUser.usersex != null){
					if(currentUser.usersex = "男"){
						$("input[name='usersex']").get(0).checked=true; 
					}else{
						$("input[name='usersex']").get(1).checked=true; 
					}
				}
				
			}else{
				if(confirm("您还没有登录，是否前往登录？")){
					location.href = "login.html";
				}else{
					location.href = "index.html";
				}

			}
			
			/*
			 * 昵称校验
			 */
			$("#userpetname").focus(function() {
				$("#txtUserpetname").hide();
			});
			$("#userpetname").bind("blur", function() {
				var upn = $("#userpetname").val().trim();
				if(upn == "" || upn == null || upn == undefined) {
					$("#txtUserpetname").html("昵称不能为空");
					$("#txtUserpetname").show();
				} else {
					if(upn != currentUser.userpetname){
						var user = {};
						user["userpetname"] = upn;
						if(isExist(user)){
							$("#txtUserpetname").html("昵称已存在！");
							$("#txtUserpetname").show();
						}else{
							upnIsNull = false;						
						}						
					}else{
						upnIsNull = false;	
					}
				}
			});
			/*
			 * 密码1校验
			 */
			$("#userpassword1").focus(function() {
				$("#txtUserpassword1").hide();
			});
			$("#userpassword1").bind("blur", function() {
				var psd1 = $("#userpassword1").val().trim();
				console.log("密码1："+psd1);
				if(psd1 == "" || psd1 == null || psd1 == undefined) {
					$("#txtUserpassword1").html("密码不能为空");
					$("#txtUserpassword1").show();
				} else {
					var myreg = /^(?:\d+|[a-zA-Z]+|[!.@#$%^&*]+){6,16}$/;
					if(!myreg.test(psd1)) {
						$("#txtUserpassword1").html("格式错误6-16位(英文+数字+'!.@#$%^&*')!");
						$("#txtUserpassword1").show();
					}
				}
			});
			/*
			 * 密码2校验
			 */
			$("#userpassword2").focus(function() {
				$("#txtUserpassword2").hide();
			});
			$("#userpassword2").bind("blur", function() {
				var psd1 = $("#userpassword1").val().trim();
				var psd2 = $("#userpassword2").val().trim();
				if(psd1 == "" || psd1 == null || psd1 == undefined) {
					$("#txtUserpassword2").html("密码不能为空");
					$("#txtUserpassword2").show();
				} else {
					if(psd1 != psd2){
						$("#txtUserpassword2").html("前后两次密码不一致");
						$("#txtUserpassword2").show();
					}else{
						upsdIsNull = false;
					}
				}
			});
			/*
			 * 手机校验
			 */
			$("#usertel").focus(function() {
				$("#txtUsertel").hide();
			});
			$("#usertel").bind("blur", function() {
				var tel = $("#usertel").val().trim();
				if(tel == "" || tel == null || tel == undefined) {
					$("#txtUsertel").html("手机号不能为空");
					$("#txtUsertel").show();
				} else {
					var myreg = /^1([38][0-9]|4[579]|5[0-3,5-9]|6[6]|7[0135678]|9[89])\d{8}$/;
					if(!myreg.test(tel)) {
						$("#txtUsertel").html("手机号格式错误");
						$("#txtUsertel").show();
					}else{
						if(tel != currentUser.usertel){
							var user = {};
							user["usertel"] = tel;
							if(isExist(user)){
								$("#txtUsertel").html("该手机号已注册！");
								$("#txtUsertel").show();
							}else{
								utlIsNull = false;						
							}							
						}else{
							utlIsNull = false;
						}
					}
				}
			});
			/*
			 * 邮箱校验
			 */
			$("#useremail").focus(function() {
				$("#txtUseremail").hide();
			});
			$("#useremail").bind("blur", function() {
				var eml = $("#useremail").val().trim();
				if(eml == "" || eml == null || eml == undefined) {
					$("#txtUseremail").html("邮箱不能为空");
					$("#txtUseremail").show();
				} else {
					var myreg = /^([a-zA-Z]|[0-9])(\w|\-)+@[a-zA-Z0-9]+\.([a-zA-Z]{2,4})$/;
					if(!myreg.test(eml)) {
						$("#txtUseremail").html("邮箱格式错误");
						$("#txtUseremail").show();
					}else{
						uemlIsNull = false;
					}
				}
			});
			
			/*
			 * 年龄校验
			 */
			$("#userage").focus(function() {
				$("#txtUserage").hide();
			});
			$("#userage").bind("blur", function() {
				var uage = $("#userage").val().trim();
				if(uage<0) {
					$("#txtUserage").html("年龄不能为负数");
					$("#txtUserage").show();
				} else {
					uageIsNull = false;
				}
			});
			
			/*
			 *校验注册信息是否已经存在
			 * */
			function isExist(param){
				var result = false;
				console.log(JSON.stringify(param));
				$.ajax({
					type: "post",
					headers: {
						'Access-Control-Allow-Origin': '*',
						'Content-Type': 'application/json; charset=UTF-8'
					},
					dataType: "json",
					url: "http://192.168.1.109:8905/selectUsers",
					data: JSON.stringify(param),
					async: false,
					success: function(data) {
						console.log(data);
						result = data.data;
					}
				});	
				return result;
			}
			/*
			 *头像上传函数
			 * */
			function iconUpload(){
				var param = new FormData($('#from-upload')[0]);
				console.log(param);
				var result = false;
				$.ajax({  
					type: "POST",  
					url:  "userIconUpload",  
					data: param,  
					async: false,
					processData: false,    //文件上传时该属性一定要为false
					contentType: false,    //文件上传时该属性一定要为false
					success: function(data){
						console.log(data);
						if(data == "上传失败！"){
							alert("头像上传失败！");
							result=false;
						}else if(data == "上传失败，文件为空！"){
							alert("头像不能为空！");
							result=false;
						}else{
							$("#icon").val(data);
							result=true;
						}
					}, 
					error: function(req, status, ex) {alert("出错了！");result=false;}
				});
				return result;
			}
			
			/*
			 *修改用户信息
			 * */
			$("#editUserBtn").click(function(){
				var result = iconUpload();
				console.log(result);
				console.log(upnIsNull);
				console.log(upsdIsNull);
				console.log(utlIsNull);
				console.log(uemlIsNull);
				console.log(uageIsNull);
				if(result&&!upnIsNull&&!upsdIsNull&&!utlIsNull&&!uemlIsNull&&!uageIsNull){
					var jsonData = $("#form-edituser").serializeJson();
					console.log(JSON.stringify(jsonData));
					$.ajax({
						type: "put",
						headers: {
							'Access-Control-Allow-Origin': '*',
							'Content-Type': 'application/json; charset=UTF-8'
						},
						dataType: "json",
						url: "http://192.168.1.109:8905/updateUsers",
						data: JSON.stringify(jsonData),
						async: true,
						success: function(data) {
							console.log(data);
							if(data.data == true){
								if(confirm("修改成功！")){
									location.reload();
								}
							}
						}
					});	
				}
			});
			
			$('#logout').click(function () {
				sessionStorage.removeItem("currentUser");
				location.href = "login.html";
			});
		</script>
		<!--js结束-->
	</body>

</html>

<body>